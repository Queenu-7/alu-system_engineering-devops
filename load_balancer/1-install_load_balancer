#!/usr/bin/env bash
# File: 1-install_load_balancer
# Installs and configures HAproxy on an Ubuntu machine (lb-01)
# to distribute traffic to web-01 and web-02 using roundrobin.

# --- Configuration Variables (REPLACE with your actual IPs) ---
# NOTE: Replace these placeholder IPs with the actual private IP addresses of your web servers
# It is best practice to use private IPs within the same VPC/Network for backend servers.
WEB_01_IP="52.90.187.27"
WEB_02_IP="52.87.176.209"
HAPROXY_CONF="/etc/haproxy/haproxy.cfg"

# --- 1. Installation ---
echo "--> Updating package lists and installing HAproxy..."
sudo apt-get update -y
sudo apt-get install -y haproxy

# --- 2. Configuration ---

echo "--> Creating new HAproxy configuration file: ${HAPROXY_CONF}"

# Using cat and tee to write the new configuration with root privileges
# This configuration includes:
# - Global and default settings
# - A frontend listening on port 80
# - A backend using the roundrobin algorithm
# - Backend servers defined with their IPs
sudo tee "$HAPROXY_CONF" > /dev/null << EOF
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    # Removed complex socket definition from global to avoid systemd conflicts
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Frontend configuration - Listens for incoming HTTP traffic on port 80
frontend http_front
    bind *:80
    default_backend http_back

# Backend configuration - Routes traffic to the web servers
backend http_back
    # Use the roundrobin balancing algorithm
    balance roundrobin
    
    # Define the backend web servers
    server web01 52.90.187.27:80 check
    server web02 52.87.176.209:80 check

# HAProxy Stats UI (Optional but recommended for monitoring)
listen stats
    bind *:8888
    stats enable
    stats uri /haproxy?stats
    stats realm Haproxy\ Statistics
    stats auth admin:password123
EOF

# --- 3. Enable HAproxy Init Script ---
# Ensure HAproxy starts automatically on boot by enabling the service
# Edit the default HAproxy configuration file to enable the service
echo "--> Enabling HAproxy service to start on boot..."
sudo sed -i 's/^ENABLED=0/ENABLED=1/' /etc/default/haproxy

# --- 4. Validation and Restart ---
echo "--> Testing HAproxy configuration..."
# Run the config check and capture output to show potential errors
CONFIG_CHECK_OUTPUT=$(sudo haproxy -c -f "$HAPROXY_CONF" 2>&1)
if [ $? -eq 0 ]; then
    echo "HAproxy configuration is valid. Restarting service..."
    # Restart the HAproxy service to load the new configuration
    sudo service haproxy restart
    echo "HAproxy service restarted successfully."
else
    echo "ERROR: HAproxy configuration failed validation."
    echo "--- Configuration Check Output ---"
    echo "$CONFIG_CHECK_OUTPUT"
    echo "----------------------------------"
    echo "Service was NOT restarted."
    exit 1
fi
